import { Injectable } from '@nestjs/common';
import { FilmDto, SessionDto } from '../films/dto/films.dto';
import { IFilmsRepository } from './films.repository.interface';

/**
 * Репозиторий фильмов в памяти
 * Используется для тестирования и разработки
 */
@Injectable()
export class FilmsInMemoryRepository implements IFilmsRepository {
  // Тестовые данные фильмов
  private readonly films: FilmDto[] = [
    {
      id: '0e33c7f6-27a7-4aa0-8e61-65d7e5effecf',
      rating: 2.9,
      director: 'Итан Райт',
      tags: ['Документальный'],
      title: 'Архитекторы общества',
      about:
        'Документальный фильм, исследующий влияние искусственного интеллекта на общество и этические, философские и социальные последствия технологии.',
      description:
        'Документальный фильм Итана Райта исследует влияние технологий на современное общество, уделяя особое внимание роли искусственного интеллекта в формировании нашего будущего. Фильм исследует этические, философские и социальные последствия гонки технологий ИИ и поднимает вопрос: какой мир мы создаём для будущих поколений.',
      image: '/bg1s.jpg',
      cover: '/bg1c.jpg',
    },
    {
      id: '51b4bc85-646d-47fc-b988-3e7051a9fe9e',
      rating: 9,
      director: 'Харрисон Рид',
      tags: ['Рекомендуемые'],
      title: 'Недостижимая утопия',
      about:
        'Провокационный фильм-антиутопия, исследующий темы свободы, контроля и цены совершенства.',
      description:
        'Провокационный фильм-антиутопия режиссера Харрисона Рида. Действие фильма разворачивается в, казалось бы, идеальном обществе, и рассказывает о группе граждан, которые начинают подвергать сомнению систему. Фильм исследует темы свободы, контроля и цены совершенства.',
      image: '/bg3s.jpg',
      cover: '/bg3c.jpg',
    },
    {
      id: '3bedbc5a-844b-40eb-9d77-83b104e0cf75',
      rating: 8.5,
      director: 'Элиза Уиттакер',
      tags: ['Рекомендуемые'],
      title: 'Звёздное путешествие',
      about:
        'Научно-фантастический фильм о команде астронавтов, исследующий темы жизнестойкости, надежды и силы человеческих связей',
      description:
        '«Звёздное путешествие» — прекрасный научно-фантастический фильм о команде астронавтов, путешествующих по галактике в поисках нового дома для человечества. Помимо потрясающей работы оператора и специалистов по визуальным эффектам, можно отметить темы, исследуемые в фильме: жизнестойкости, надежды и силы человеческих связей.',
      image: '/bg5s.jpg',
      cover: '/bg5c.jpg',
    },
    {
      id: '5b70cb1a-61c9-47b1-b207-31f9e89087ff',
      rating: 8.9,
      director: 'Лила Васкес',
      tags: ['Рекомендуемые'],
      title: 'Стражи Гримуара',
      about:
        'Фэнтезийное приключение об истинном значении дружбы, мужества и силы знаний',
      description:
        'Захватывающее фэнтезийное приключение, которое рассказывает о группе героев, которые должны защитить древний магический том от попадания в руки тёмного колдуна. История об истинном значении дружбы, мужества и силы знаний.',
      image: '/bg2s.jpg',
      cover: '/bg2c.jpg',
    },
    {
      id: '0354a762-8928-427f-81d7-1656f717f39c',
      rating: 9.5,
      director: 'Оливер Беннет',
      tags: ['Рекомендуемые'],
      title: 'Парадокс Нексуса',
      about:
        'Фильм об эксперименте по соединению человеческих умов. Исследует вопросы неприкосновенности частной жизни, идентичности и самой природы человеческого сознания',
      description:
        'В фильме исследуются последствия новаторского эксперимента по соединению человеческих умов. По мере развития проекта участники сталкиваются с вопросами неприкосновенности частной жизни, идентичности и самой природы человеческого сознания.',
      image: '/bg4s.jpg',
      cover: '/bg4c.jpg',
    },
    {
      id: '92b8a2a7-ab6b-4fa9-915b-d27945865e39',
      rating: 8.1,
      director: 'Амелия Хьюз',
      tags: ['Рекомендуемые'],
      title: 'Сон в летний день',
      about:
        'Фэнтези-фильм о группе друзей попавших в волшебный лес, где время остановилось.',
      description:
        'Причудливый фэнтези-фильм, действие которого происходит в волшебном лесу, где время остановилось. Группа друзей натыкается на это заколдованное царство и поначалу проникается беззаботным духом обитателей, но потом друзьям приходится разойтись. А как встретиться снова, если нет ни времени, ни места встречи?',
      image: '/bg6s.jpg',
      cover: '/bg6c.jpg',
    },
  ];

  // Тестовые данные сеансов
  private readonly sessions: Record<string, SessionDto[]> = {
    '0e33c7f6-27a7-4aa0-8e61-65d7e5effecf': [
      {
        id: 'session-1',
        daytime: '2024-01-15T10:00:00.000Z',
        hall: 1,
        rows: 10,
        seats: 20,
        price: 350,
        taken: ['1:5', '1:6', '2:3'],
      },
      {
        id: 'session-2',
        daytime: '2024-01-15T18:00:00.000Z',
        hall: 2,
        rows: 8,
        seats: 15,
        price: 400,
        taken: ['3:7', '4:2'],
      },
    ],
    '51b4bc85-646d-47fc-b988-3e7051a9fe9e': [
      {
        id: 'session-3',
        daytime: '2024-01-16T14:00:00.000Z',
        hall: 1,
        rows: 12,
        seats: 25,
        price: 450,
        taken: ['5:10', '6:8'],
      },
    ],
  };

  /**
   * Получить все фильмы
   */
  async findAll(): Promise<FilmDto[]> {
    return [...this.films];
  }

  /**
   * Получить фильм по ID
   */
  async findById(id: string): Promise<FilmDto | null> {
    const film = this.films.find((f) => f.id === id);
    return film || null;
  }

  /**
   * Получить расписание фильма по ID
   */
  async getFilmSchedule(id: string): Promise<SessionDto[]> {
    return this.sessions[id] || [];
  }

  /**
   * Обновить занятые места в сеансе
   */
  async updateSessionTakenSeats(
    filmId: string,
    sessionId: string,
    takenSeats: string[],
  ): Promise<boolean> {
    const filmSessions = this.sessions[filmId];
    if (!filmSessions) {
      return false;
    }

    const sessionIndex = filmSessions.findIndex((s) => s.id === sessionId);
    if (sessionIndex === -1) {
      return false;
    }

    // Обновляем занятые места
    this.sessions[filmId][sessionIndex].taken = takenSeats;
    return true;
  }
}
